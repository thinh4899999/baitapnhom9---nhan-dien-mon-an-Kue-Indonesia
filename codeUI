# =============================================================================
# GIAO DIá»†N Äá» N GIáº¢N CHO GOOGLE COLAB - HOáº T Äá»˜NG 100%
# =============================================================================

# Import cÃ¡c thÆ° viá»‡n cÆ¡ báº£n
import tensorflow as tf
from tensorflow.keras.models import load_model
from tensorflow.keras.utils import load_img, img_to_array
import numpy as np
import matplotlib.pyplot as plt
from PIL import Image
import os
from google.colab import files
import io

print("âœ… ÄÃ£ import thÃ nh cÃ´ng cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t")

# =============================================================================
# CLASS CHÃNH - ÄÆ N GIáº¢N VÃ€ HIá»†U QUáº¢
# =============================================================================

class SimpleFoodClassifier:
    def __init__(self):
        self.model = None
        self.IMG_SIZE = 224
        self.class_names = ['kue_dadar_gulung', 'kue_klepon', 'kue_putu']
        self.food_info = {
            'kue_dadar_gulung': {
                'name': 'Kue Dadar Gulung ğŸ¥',
                'description': 'BÃ¡nh crepe xanh cuá»™n nhÃ¢n dá»«a náº¡o'
            },
            'kue_klepon': {
                'name': 'Kue Klepon ğŸ¡', 
                'description': 'BÃ¡nh náº¿p trÃ²n nhÃ¢n Ä‘Æ°á»ng thá»‘t ná»‘t, phá»§ dá»«a'
            },
            'kue_putu': {
                'name': 'Kue Putu ğŸ§',
                'description': 'BÃ¡nh háº¥p tre truyá»n thá»‘ng nhiá»u mÃ u sáº¯c'
            }
        }
        print("ğŸ¯ Indonesian Food Classifier Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi táº¡o")
    
    def load_model(self):
        """Táº£i model AI"""
        print("ğŸ” Äang tÃ¬m kiáº¿m model...")
        
        # Danh sÃ¡ch cÃ¡c file model cÃ³ thá»ƒ cÃ³
        model_files = [
            'best_kue_model.h5',
            'kue_classifier_final.h5', 
            'improved_cnn_model.h5',
            'best_model.h5',
            'nhandienmonan.h5'
        ]
        
        # ThÃªm path /content/ 
        all_paths = model_files + [f'/content/{f}' for f in model_files]
        
        # TÃ¬m model cÃ³ sáºµn
        found_model = None
        for path in all_paths:
            if os.path.exists(path):
                found_model = path
                break
        
        if found_model is None:
            print("âŒ KHÃ”NG TÃŒM THáº¤Y MODEL!")
            print("ğŸ“‹ CÃ¡c file cáº§n thiáº¿t:")
            for f in model_files[:3]:
                print(f"   â€¢ {f}")
            print("\nğŸ’¡ Giáº£i phÃ¡p:")
            print("1. Cháº¡y code training trÆ°á»›c Ä‘á»ƒ táº¡o model")
            print("2. Äáº£m báº£o file model Ä‘Æ°á»£c lÆ°u thÃ nh cÃ´ng")
            print("3. Kiá»ƒm tra tÃªn file chÃ­nh xÃ¡c")
            return False
        
        try:
            print(f"â³ Äang táº£i model tá»«: {found_model}")
            self.model = load_model(found_model)
            print(f"âœ… ÄÃƒ TÃI MODEL THÃ€NH CÃ”NG!")
            print(f"ğŸ¯ Sáºµn sÃ ng nháº­n diá»‡n 3 loáº¡i kue Indonesia")
            return True
            
        except Exception as e:
            print(f"âŒ Lá»—i khi táº£i model: {str(e)}")
            return False
    
    def upload_image(self):
        """Upload áº£nh tá»« mÃ¡y tÃ­nh"""
        print("ğŸ“¤ Chá»n áº£nh tá»« mÃ¡y tÃ­nh cá»§a báº¡n...")
        uploaded = files.upload()
        
        if not uploaded:
            print("âŒ KhÃ´ng cÃ³ file nÃ o Ä‘Æ°á»£c chá»n")
            return None
        
        # Láº¥y file Ä‘áº§u tiÃªn
        filename = list(uploaded.keys())[0]
        print(f"âœ… ÄÃ£ upload: {filename}")
        
        return filename
    
    def predict_image(self, image_path):
        """Dá»± Ä‘oÃ¡n áº£nh"""
        if self.model is None:
            print("âŒ ChÆ°a load model! Cháº¡y load_model() trÆ°á»›c")
            return
        
        try:
            # Load vÃ  hiá»ƒn thá»‹ áº£nh gá»‘c
            img = Image.open(image_path)
            print("ğŸ“· áº¢nh gá»‘c:")
            plt.figure(figsize=(8, 6))
            plt.imshow(img)
            plt.title('áº¢nh Ä‘áº§u vÃ o', fontsize=14, fontweight='bold')
            plt.axis('off')
            plt.show()
            
            # Preprocess áº£nh
            img_processed = img.resize((self.IMG_SIZE, self.IMG_SIZE))
            if img_processed.mode != 'RGB':
                img_processed = img_processed.convert('RGB')
            
            img_array = np.array(img_processed)
            img_array = np.expand_dims(img_array, axis=0)  
            img_array = img_array.astype('float32') / 255.0
            
            print("ğŸ§  AI Ä‘ang phÃ¢n tÃ­ch...")
            
            # Dá»± Ä‘oÃ¡n
            predictions = self.model.predict(img_array, verbose=0)
            predicted_idx = np.argmax(predictions[0])
            confidence = predictions[0][predicted_idx]
            predicted_class = self.class_names[predicted_idx]
            
            # Hiá»ƒn thá»‹ káº¿t quáº£ chÃ­nh
            print("=" * 50)
            print("ğŸ‰ Káº¾T QUáº¢ NHáº¬N DIá»†N:")
            print("=" * 50)
            
            food_name = self.food_info[predicted_class]['name']
            food_desc = self.food_info[predicted_class]['description']
            
            print(f"ğŸ½ï¸  MÃ“N Ä‚N: {food_name}")
            print(f"ğŸ“  MÃ” Táº¢: {food_desc}")
            print(f"ğŸ¯  Äá»˜ TIN Cáº¬Y: {confidence:.2%}")
            
            # ÄÃ¡nh giÃ¡ Ä‘á»™ tin cáº­y
            if confidence >= 0.8:
                print("âœ…  ÄÃNH GIÃ: Ráº¥t chÃ­nh xÃ¡c")
            elif confidence >= 0.6:
                print("âš ï¸   ÄÃNH GIÃ: KhÃ¡ chÃ­nh xÃ¡c")
            else:
                print("â“  ÄÃNH GIÃ: Cáº§n xem xÃ©t thÃªm")
            
            print("=" * 50)
            print("ğŸ“Š CHI TIáº¾T Táº¤T Cáº¢ Dá»° ÄOÃN:")
            print("=" * 50)
            
            # Hiá»ƒn thá»‹ táº¥t cáº£ predictions
            for i, (class_name, prob) in enumerate(zip(self.class_names, predictions[0])):
                food_name = self.food_info[class_name]['name']
                percentage = prob * 100
                
                # Táº¡o thanh progress Ä‘Æ¡n giáº£n báº±ng kÃ½ tá»±
                bar_length = 30
                filled_length = int(percentage / 100 * bar_length)
                bar = 'â–ˆ' * filled_length + 'â–‘' * (bar_length - filled_length)
                
                print(f"{food_name:25} â”‚{bar}â”‚ {percentage:5.1f}%")
            
            print("=" * 50)
            
            # Váº½ biá»ƒu Ä‘á»“
            self.plot_predictions(predictions[0])
            
            return predicted_class, confidence
            
        except Exception as e:
            print(f"âŒ Lá»—i khi phÃ¢n tÃ­ch: {str(e)}")
            return None, 0
    
    def plot_predictions(self, predictions):
        """Váº½ biá»ƒu Ä‘á»“ káº¿t quáº£"""
        food_names = [self.food_info[name]['name'] for name in self.class_names]
        percentages = predictions * 100
        
        plt.figure(figsize=(12, 6))
        
        # Subplot 1: Bar chart
        plt.subplot(1, 2, 1)
        colors = ['#FF6B6B', '#4ECDC4', '#45B7D1']
        bars = plt.bar(food_names, percentages, color=colors, alpha=0.8)
        plt.title('Káº¿t Quáº£ Dá»± ÄoÃ¡n', fontsize=14, fontweight='bold')
        plt.ylabel('XÃ¡c Suáº¥t (%)')
        plt.xticks(rotation=45, ha='right')
        
        # ThÃªm text trÃªn bars
        for bar, pct in zip(bars, percentages):
            height = bar.get_height()
            plt.text(bar.get_x() + bar.get_width()/2., height + 1,
                    f'{pct:.1f}%', ha='center', va='bottom', fontweight='bold')
        
        # Subplot 2: Pie chart
        plt.subplot(1, 2, 2)
        plt.pie(percentages, labels=food_names, colors=colors, autopct='%1.1f%%', 
                startangle=90, textprops={'fontsize': 10})
        plt.title('PhÃ¢n Bá»‘ XÃ¡c Suáº¥t', fontsize=14, fontweight='bold')
        
        plt.tight_layout()
        plt.show()

# =============================================================================
# FUNCTIONS ÄÆ N GIáº¢N Äá»‚ Sá»¬ Dá»¤NG
# =============================================================================

def quick_start():
    """HÃ m khá»Ÿi Ä‘á»™ng nhanh"""
    print("ğŸš€ KHá»I Äá»˜NG INDONESIAN FOOD AI")
    print("=" * 50)
    
    # Táº¡o classifier
    classifier = SimpleFoodClassifier()
    
    # Load model
    if not classifier.load_model():
        return None
    
    print("\nâœ… Sáº´N SÃ€NG Sá»¬ Dá»¤NG!")
    print("ğŸ“± Sá»­ dá»¥ng cÃ¡c lá»‡nh sau:")
    print("   â€¢ classifier.upload_and_predict() - Upload vÃ  nháº­n diá»‡n")
    print("   â€¢ classifier.predict_image('path/to/image.jpg') - Dá»± Ä‘oÃ¡n áº£nh cÃ³ sáºµn")
    
    return classifier

def upload_and_predict():
    """Upload áº£nh vÃ  dá»± Ä‘oÃ¡n ngay"""
    classifier = SimpleFoodClassifier()
    
    print("ğŸ¤– BÆ°á»›c 1: Táº£i model AI...")
    if not classifier.load_model():
        return
    
    print("\nğŸ“¤ BÆ°á»›c 2: Upload áº£nh...")
    image_path = classifier.upload_image()
    if image_path is None:
        return
    
    print(f"\nğŸ” BÆ°á»›c 3: PhÃ¢n tÃ­ch áº£nh {image_path}...")
    result = classifier.predict_image(image_path)
    
    if result[0]:
        print(f"\nğŸ‰ HOÃ€N Táº¤T! MÃ³n Äƒn Ä‘Æ°á»£c nháº­n diá»‡n: {result[0]}")
    
    return result

def test_sample_image(image_path):
    """Test vá»›i áº£nh cÃ³ sáºµn"""
    classifier = SimpleFoodClassifier()
    
    if not classifier.load_model():
        return
    
    if not os.path.exists(image_path):
        print(f"âŒ KhÃ´ng tÃ¬m tháº¥y file: {image_path}")
        return
    
    return classifier.predict_image(image_path)

# =============================================================================
# CHáº Y DEMO
# =============================================================================

print("ğŸŒŸ INDONESIAN FOOD AI - SIMPLE VERSION")
print("ğŸ¯ Nháº­n diá»‡n 3 loáº¡i kue truyá»n thá»‘ng Indonesia")
print("ğŸ¥ Kue Dadar Gulung â€¢ ğŸ¡ Kue Klepon â€¢ ğŸ§ Kue Putu")
print("=" * 60)

print("ğŸ“‹ CÃCH Sá»¬ Dá»¤NG:")
print("1. Cháº¡y: classifier = quick_start()")
print("2. Upload áº£nh: upload_and_predict()")
print("3. Hoáº·c test áº£nh cÃ³ sáºµn: test_sample_image('path/image.jpg')")
print("=" * 60)

# Tá»± Ä‘á»™ng táº¡o classifier sáºµn sÃ ng
try:
    print("ğŸ”„ Äang khá»Ÿi táº¡o classifier tá»± Ä‘á»™ng...")
    food_classifier = quick_start()
    
    if food_classifier:
        print("\nğŸ‰ THÃ€NH CÃ”NG!")
        print("ğŸš€ Classifier Ä‘Ã£ sáºµn sÃ ng trong biáº¿n 'food_classifier'")
        print("\nğŸ’¡ Sá»­ dá»¥ng ngay:")
        print("   upload_and_predict()  # Upload áº£nh tá»« mÃ¡y tÃ­nh")
        
        # ThÃªm method tiá»‡n lá»£i
        food_classifier.upload_and_predict = lambda: upload_and_predict()
        
    else:
        print("\nâš ï¸  Cáº§n cháº¡y code training trÆ°á»›c Ä‘á»ƒ táº¡o model!")
        
except Exception as e:
    print(f"âŒ Lá»—i khá»Ÿi táº¡o: {str(e)}")
    print("ğŸ’¡ Cháº¡y thá»§ cÃ´ng: classifier = SimpleFoodClassifier()")

print("\n" + "="*60)
print("âœ¨ Ready to classify Indonesian food! âœ¨")
print("="*60)
